@inherits LayoutComponentBase
@using OnlineShop_CourseSubmission_CS.Components
@using OnlineShop_CourseSubmission_CS.Component
@using OnlineShop_CourseSubmission_CS.Data
@using System.Text.Json;
@using System.Text.Json.Serialization;
@using System.Linq;


<div class="page">
    <div class="sidebar" @onclick="()=> SearchString = string.Empty">
        <NavMenu />
    </div>

    <main>
        <div class="top-row px-4">
            <div class="form">
                <input required
                       type="text"
                       @bind="SearchString"
                       @onkeyup="Enter"
                       class="search-input"
                       placeholder="search products.." />
                <button type="button" @onclick="()=>HandleSearch(SearchString)" class="search-icon oi oi-magnifying-glass p-2"></button>
            </div>
            <a class="btn-icon oi oi-heart" href="wishlist" title="Your Wishlist"></a>
            <a class="btn-icon oi oi-cart m-3" href="cart" title="Your Cart">
                @if (ShoppingCart.TotalQuantity != 0) {
                    <span class="cart-count">@ShoppingCart.TotalQuantity</span>
                }
            </a>
        </div>

        <article class="content px-4">
            @if (!string.IsNullOrEmpty(SearchString))
            {
                @if (SearchedProducts != null)
                {
                    <h4>Your search for @SearchString:</h4>
                    <div class="container flex flex-column flex-wrap gap-2">
                        @foreach (var item in SearchedProducts)
                        {
                            <div class="cartItemsList">
                                <div class="card">
                                    <a href="/product/@item.Id">
                                        <div class="added-card">
                                            <img src=@item.Image class="card-img-top" alt="products">
                                        </div>
                                    </a>
                                    <div class="card-body overflow-auto" style="height:300px">
                                        <h5 class="card-title">@item.Title</h5>
                                        <p class="card-text">@item.Description</p>
                                    </div>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item">€@item.Price</li>
                                    </ul>
                                    <div class="card-body d-flex justify-content-between">
                                        <a class="more-info-btn" href="/product/@item.Id">More <span class="small-hidden">info</span></a>
                                        <div>
                                            <button class="card-button" title="add to wishlist" @onclick="()=>WishItem.AddToWish(item.Id)">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-clipboard-heart" viewBox="0 0 16 16">
                                                    <path fill-rule="evenodd" d="M5 1.5A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5v1A1.5 1.5 0 0 1 9.5 4h-3A1.5 1.5 0 0 1 5 2.5v-1Zm5 0a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-1Z" />
                                                    <path d="M3 1.5h1v1H3a1 1 0 0 0-1 1V14a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V3.5a1 1 0 0 0-1-1h-1v-1h1a2 2 0 0 1 2 2V14a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V3.5a2 2 0 0 1 2-2Z" />
                                                    <path d="M8 6.982C9.664 5.309 13.825 8.236 8 12 2.175 8.236 6.336 5.31 8 6.982Z" />
                                                </svg>
                                            </button>
                                            <button class="card-button" title="add to cart" @onclick="()=>ShoppingCart.AddToCart(item.Id)">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-cart-plus" viewBox="0 0 16 16">
                                                    <path d="M9 5.5a.5.5 0 0 0-1 0V7H6.5a.5.5 0 0 0 0 1H8v1.5a.5.5 0 0 0 1 0V8h1.5a.5.5 0 0 0 0-1H9V5.5z" />
                                                    <path d="M.5 1a.5.5 0 0 0 0 1h1.11l.401 1.607 1.498 7.985A.5.5 0 0 0 4 12h1a2 2 0 1 0 0 4 2 2 0 0 0 0-4h7a2 2 0 1 0 0 4 2 2 0 0 0 0-4h1a.5.5 0 0 0 .491-.408l1.5-8A.5.5 0 0 0 14.5 3H2.89l-.405-1.621A.5.5 0 0 0 2 1H.5zm3.915 10L3.102 4h10.796l-1.313 7h-8.17zM6 14a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm7 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z" />
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                    @if (!SearchedProducts.Any()) {
                        <p class="no-match">Sorry, no products matched your search. Try other searchwords.</p>
                    }
                }
            }
            else
            {
                @Body
            }
        </article>
        <footer>
            <p>This is an OnlineShop with Blazor (C# .NET) by <span>Mia Chen</span> & <span>Emma Gabrielsson</span></p>
        </footer>
    </main>
</div>

@code {

    private string? SearchString { get; set; }
    private Products[]? SearchedProducts;

    //Function to get searched products and filter them into SearchedProducts array.
    private async Task HandleSearch(string keyword)
    {
        DataService data = new DataService();
        Products[] AllProducts = await data.GetAllProducts();
        SearchedProducts = AllProducts.Where(p => p.Title.ToLower().Contains(keyword.ToLower())).ToArray();
    }

    private void Enter(KeyboardEventArgs e)
    {
        if (e.Code == "Enter" || e.Code == "NumpadEnter")
        {
            var s = SearchString;
            HandleSearch(s);
        }
    }
    
}

